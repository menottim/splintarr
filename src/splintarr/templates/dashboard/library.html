{% extends "base.html" %}

{% block title %}Library - Splintarr{% endblock %}

{% block content %}
<hgroup>
    <h1>Library</h1>
    <p>{{ stats.total_items }} items &middot; {{ stats.complete_count }} complete &middot; {{ stats.missing_count }} missing</p>
</hgroup>

<!-- Filters and actions -->
<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
    {% include "components/library_filters.html" %}

    <a href="/dashboard/library/missing" role="button" class="secondary" style="margin-bottom: 0;">Missing Only</a>
    <a href="/dashboard/library/cutoff" role="button" class="secondary" style="margin-bottom: 0;">Cutoff Unmet</a>

    {% if request.query_string %}
    <a href="{{ request.path }}" style="font-size: 0.875rem;">Clear filters</a>
    {% endif %}

    <button id="sync-btn" class="secondary" style="margin-left: auto; margin-bottom: 0;" data-action="sync-library">Refresh Library</button>
</div>

<!-- Poster grid -->
{% if items %}
<div class="poster-grid">
    {% for item in items %}
    <a href="/dashboard/library/{{ item.id }}" class="poster-card">
        {% if item.poster_path %}
        <img src="/posters/{{ item.poster_path }}" alt="{{ item.title }}" class="poster-img" loading="lazy" />
        {% else %}
        <div class="poster-placeholder">
            <svg viewBox="0 0 100 150" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="150" fill="#252832"/>
                <text x="50" y="70" text-anchor="middle" fill="#5a6169" font-size="10">No Poster</text>
                <text x="50" y="85" text-anchor="middle" fill="#5a6169" font-size="8">{{ item.content_type }}</text>
            </svg>
        </div>
        {% endif %}
        <div class="poster-info">
            <div class="poster-title">
                {{ item.title }}
                {% if excluded_set and (item.external_id, item.content_type) in excluded_set %}
                <span style="color: var(--del-color); font-size: 0.7rem; font-weight: 600;" title="Excluded from searches">&#10007; excluded</span>
                {% endif %}
            </div>
            {% if item.year %}<div class="poster-year">{{ item.year }}</div>{% endif %}
            <div class="poster-progress">
                <progress value="{{ item.episode_have }}" max="{{ item.episode_count }}" style="height: 4px; margin: 0;"></progress>
                <small class="{% if item.is_complete %}text-success{% elif item.missing_count > 0 %}text-warning{% endif %}">
                    {{ item.completion_pct }}%
                </small>
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<article>
    <p class="empty-state">
        {% if stats.total_items == 0 %}
        {% include "components/onboarding_steps.html" %}
        No library data yet. Click <strong>Refresh Library</strong> to sync from your instances, or <a href="/dashboard/instances">add an instance</a> first.
        {% else %}
        No items match the current filters.
        {% endif %}
    </p>
</article>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
function applyFilters() {
    var params = new URLSearchParams();
    var inst = document.getElementById('filter-instance').value;
    var type = document.getElementById('filter-type').value;
    if (inst) params.set('instance_id', inst);
    if (type) params.set('content_type', type);
    var qs = params.toString();
    window.location.href = '/dashboard/library' + (qs ? '?' + qs : '');
}

document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    if (target.dataset.action === 'sync-library') syncLibrary();
});

async function syncLibrary() {
    var btn = document.getElementById('sync-btn');
    btn.setAttribute('aria-busy', 'true');
    btn.disabled = true;
    btn.textContent = 'Syncing...';
    try {
        var response = await fetch('/api/library/sync', { method: 'POST' });
        if (!response.ok) {
            var data = await response.json();
            showNotification('Sync failed: ' + (data.detail || 'Unknown error'));
            btn.setAttribute('aria-busy', 'false');
            btn.disabled = false;
            btn.textContent = 'Refresh Library';
            return;
        }
    } catch (error) {
        showNotification('Sync failed: ' + error.message);
        btn.setAttribute('aria-busy', 'false');
        btn.disabled = false;
        btn.textContent = 'Refresh Library';
        return;
    }

    // Build fullscreen overlay using safe DOM methods
    var overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';

    var article = document.createElement('article');
    article.setAttribute('aria-busy', 'true');
    article.style.cssText = 'max-width:400px;width:90%;text-align:center;margin:0;';

    var heading = document.createElement('p');
    heading.textContent = 'Syncing library...';
    heading.style.cssText = 'font-size:1.25rem;font-weight:600;margin-bottom:0.5rem;';

    var detail = document.createElement('small');
    detail.textContent = 'Starting sync...';
    detail.style.display = 'block';

    var elapsed = document.createElement('small');
    elapsed.style.cssText = 'display:block;margin-top:0.5rem;color:var(--muted-color);';
    elapsed.textContent = '';
    var syncStartTime = Date.now();

    var errorSection = document.createElement('div');
    errorSection.style.cssText = 'margin-top:1rem;text-align:left;display:none;';

    article.appendChild(heading);
    article.appendChild(detail);
    article.appendChild(elapsed);
    article.appendChild(errorSection);
    overlay.appendChild(article);
    document.body.appendChild(overlay);

    function formatElapsed(ms) {
        var secs = Math.floor(ms / 1000);
        if (secs < 60) return secs + 's';
        var mins = Math.floor(secs / 60);
        secs = secs % 60;
        return mins + 'm ' + secs + 's';
    }

    // Poll sync status every 2 seconds
    var pollInterval = setInterval(async function() {
        try {
            // Update elapsed time
            elapsed.textContent = 'Elapsed: ' + formatElapsed(Date.now() - syncStartTime);

            var statusResp = await fetch('/api/library/sync-status');
            if (statusResp.ok) {
                var s = await statusResp.json();

                // Update progress detail while syncing
                if (s.syncing && s.current_instance) {
                    var progressText = 'Instance ' + (s.instances_done + 1) + '/' + s.total_instances + ': ' + s.current_instance;
                    if (s.stage) {
                        progressText += '\n' + s.stage;
                    }
                    if (s.items_total > 0) {
                        progressText += ' (' + s.items_synced + '/' + s.items_total + ')';
                    }
                    detail.textContent = progressText;
                    detail.style.whiteSpace = 'pre-line';
                } else if (s.syncing) {
                    detail.textContent = 'Preparing sync...';
                }

                if (!s.syncing) {
                    clearInterval(pollInterval);

                    if (s.errors && s.errors.length > 0) {
                        // Show errors — do NOT auto-reload
                        article.removeAttribute('aria-busy');
                        heading.textContent = 'Sync completed with errors';
                        heading.style.color = 'var(--del-color)';
                        detail.textContent = s.items_synced + ' items synced from ' + s.total_instances + ' instance(s).';

                        errorSection.style.display = 'block';

                        var errorLabel = document.createElement('p');
                        errorLabel.textContent = 'Errors:';
                        errorLabel.style.cssText = 'font-weight:600;margin-bottom:0.25rem;color:var(--del-color);';
                        errorSection.appendChild(errorLabel);

                        var errorList = document.createElement('ul');
                        errorList.style.cssText = 'font-size:0.85rem;padding-left:1.25rem;margin-bottom:1rem;';
                        s.errors.forEach(function(err) {
                            var li = document.createElement('li');
                            li.textContent = err;
                            errorList.appendChild(li);
                        });
                        errorSection.appendChild(errorList);

                        var reloadBtn = document.createElement('button');
                        reloadBtn.textContent = 'Reload Page';
                        reloadBtn.style.cssText = 'width:100%;';
                        reloadBtn.addEventListener('click', function() { location.reload(); });
                        errorSection.appendChild(reloadBtn);
                    } else {
                        // No errors — auto-reload
                        location.reload();
                    }
                }
            }
        } catch (e) {
            // Polling error — keep trying
        }
    }, 2000);
}
</script>
{% endblock %}
