{% extends "base.html" %}

{% block title %}Add Instance - Vibe-Quality-Searcharr{% endblock %}

{% block content %}
<div class="setup-wizard-container">
    <!-- Progress indicator -->
    <div class="setup-progress">
        <span class="step completed" data-step="✓">Welcome</span>
        <span class="step completed" data-step="✓">Admin Account</span>
        <span class="step active" data-step="3">Instance</span>
        <span class="step" data-step="4">Complete</span>
    </div>

    <hgroup>
        <h1>Add Your First Instance</h1>
        <p>Connect to Sonarr or Radarr to start automating searches</p>
    </hgroup>

    <div class="setup-content">
        <article>
            <form action="/setup/instance" method="post" id="instanceForm">
                <div class="form-group">
                    <label for="instance_type">
                        Instance Type
                        <select id="instance_type" name="instance_type" required>
                            <option value="">Select type...</option>
                            <option value="sonarr" {% if instance_type == 'sonarr' %}selected{% endif %}>Sonarr (TV Shows)</option>
                            <option value="radarr" {% if instance_type == 'radarr' %}selected{% endif %}>Radarr (Movies)</option>
                        </select>
                    </label>
                </div>

                <div class="form-group">
                    <label for="name">
                        Instance Name
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            placeholder="e.g., Main Sonarr, 4K Radarr"
                            value="{{ name or '' }}">
                        <small>Friendly name to identify this instance</small>
                    </label>
                </div>

                <div class="form-group">
                    <label for="url">
                        URL
                        <input
                            type="url"
                            id="url"
                            name="url"
                            required
                            placeholder="http://localhost:8989"
                            value="{{ url or '' }}">
                        <small>Full URL including port (e.g., http://localhost:8989 or http://192.168.1.100:7878)</small>
                    </label>
                </div>

                <div class="form-group">
                    <label for="api_key">
                        API Key
                        <input
                            type="text"
                            id="api_key"
                            name="api_key"
                            required
                            placeholder="Enter your API key"
                            autocomplete="off">
                        <small>Found in Settings > General > Security in Sonarr/Radarr</small>
                    </label>
                </div>

                <div id="testResult"></div>

                <div class="setup-actions" style="margin-top: 1.5rem;">
                    <button type="button" class="secondary" onclick="testConnection()">Test Connection</button>
                    <div class="btn-group">
                        <a href="/setup/instance/skip" role="button" class="secondary">Skip (Add Later)</a>
                        <button type="submit" id="submitBtn">Continue →</button>
                    </div>
                </div>
            </form>
        </article>

        <article>
            <h4>Where to find your API key:</h4>
            <ol>
                <li>Open your Sonarr or Radarr web interface</li>
                <li>Navigate to <strong>Settings → General</strong></li>
                <li>Scroll down to the <strong>Security</strong> section</li>
                <li>Copy the <strong>API Key</strong> value</li>
            </ol>
        </article>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function testConnection() {
    const testResult = document.getElementById('testResult');
    const instanceType = document.getElementById('instance_type').value;
    const url = document.getElementById('url').value;
    const apiKey = document.getElementById('api_key').value;

    if (!instanceType || !url || !apiKey) {
        testResult.innerHTML = '<div class="alert alert-danger" style="margin-top: 1rem;">Please fill in all fields</div>';
        return;
    }

    testResult.innerHTML = '<div class="alert alert-info" style="margin-top: 1rem;"><progress></progress> Testing connection...</div>';

    try {
        const response = await fetch('/api/instances/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                instance_type: instanceType,
                url: url,
                api_key: apiKey
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            testResult.innerHTML = `
                <div class="alert alert-success" style="margin-top: 1rem;">
                    <strong>✓ Connection successful!</strong><br>
                    Version: ${data.version || 'Unknown'}<br>
                    ${instanceType === 'sonarr' ? 'Series' : 'Movies'}: ${data.items_count || 0}
                </div>
            `;
        } else {
            testResult.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">✗ Connection failed: ${data.message || 'Unknown error'}</div>`;
        }
    } catch (error) {
        testResult.innerHTML = `<div class="alert alert-danger" style="margin-top: 1rem;">✗ Connection failed: ${error.message}</div>`;
    }
}
</script>
{% endblock %}
