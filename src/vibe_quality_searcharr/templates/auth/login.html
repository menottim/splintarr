{% extends "base.html" %}

{% block title %}Login - Vibe-Quality-Searcharr{% endblock %}

{% block content %}
<div style="max-width: 500px; margin: 4rem auto;">
    <hgroup>
        <h1>Login</h1>
        <p id="loginSubtitle">Sign in to access your Vibe-Quality-Searcharr dashboard</p>
    </hgroup>

    <form action="/api/auth/login" method="post" id="loginForm">
        <label for="username">
            Username
            <input type="text" id="username" name="username" required autocomplete="username">
        </label>

        <label for="password">
            Password
            <input type="password" id="password" name="password" required autocomplete="current-password">
        </label>

        <button type="submit" id="submitBtn">Login</button>
    </form>

    <form id="totpForm" style="display: none;">
        <label for="totp_code">
            Authenticator Code
            <input type="text" id="totp_code" name="code" required autocomplete="one-time-code"
                   inputmode="numeric" pattern="\d{6}" maxlength="6"
                   placeholder="Enter 6-digit code">
        </label>

        <button type="submit" id="totpSubmitBtn">Verify</button>
        <a href="/login" role="button" class="secondary outline" style="margin-top: 0.5rem; display: block; text-align: center;">Use a different account</a>
    </form>
</div>

<script nonce="{{ request.state.csp_nonce }}">
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');

        const formData = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value
        };

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                if (data.requires_2fa) {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('totpForm').style.display = 'block';
                    document.getElementById('loginSubtitle').textContent = 'Enter the code from your authenticator app';
                    document.getElementById('totp_code').focus();
                } else {
                    window.location.href = '/dashboard';
                }
            } else {
                alert(data.detail || 'Login failed');
                submitBtn.disabled = false;
                submitBtn.setAttribute('aria-busy', 'false');
            }
        } catch (error) {
            alert('Login failed: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.setAttribute('aria-busy', 'false');
        }
    });

    document.getElementById('totpForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById('totpSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');

        const code = document.getElementById('totp_code').value;

        try {
            const response = await fetch('/api/auth/2fa/login-verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            });

            if (response.ok) {
                window.location.href = '/dashboard';
            } else {
                const data = await response.json();
                alert(data.detail || 'Verification failed');
                submitBtn.disabled = false;
                submitBtn.setAttribute('aria-busy', 'false');
                document.getElementById('totp_code').value = '';
                document.getElementById('totp_code').focus();
            }
        } catch (error) {
            alert('Verification failed: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.setAttribute('aria-busy', 'false');
        }
    });
</script>
{% endblock %}
