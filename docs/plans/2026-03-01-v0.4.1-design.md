# v0.4.1 Design — Bug Fixes + UX Polish

**Date:** 2026-03-01
**Status:** Approved
**Source:** Hand-testing notes from Windows deployment

---

## Bug 1: Scheduler Serialization Error (blocking)

**Root cause:** APScheduler's `SQLAlchemyJobStore` tries to serialize job functions. The DB engine was created with `creator=creator` where `creator` is a closure inside `create_database_engine()` — closures can't be serialized.

**Fix:** Replace `SQLAlchemyJobStore` with `MemoryJobStore`. In a single-container, single-worker Docker app, job persistence across restarts adds no value — queues are re-scheduled from the database on startup. This eliminates the serialization issue entirely and removes APScheduler competing for the SQLCipher database lock.

## Bug 2: SQLCipher "database is locked" (blocking)

**Root cause:** SQLCipher defaults to exclusive locking. During library sync (which can take minutes for large libraries), every other connection — health checks, page loads, auth queries — fails at the PRAGMA stage.

**Fix:** Two changes:
1. Enable WAL mode via `PRAGMA journal_mode = WAL` in the connection setup. WAL allows concurrent readers during writes.
2. Add `PRAGMA busy_timeout = 5000` (5 second wait) so short-lived lock contention resolves automatically.

WAL mode must be set after the SQLCipher key PRAGMA, and persists across connections.

## UX 3: Library Refresh Loading Animation

Show a persistent spinner when library sync is triggered. The existing endpoint returns immediately (background task). Add polling: JS checks `/api/library/sync-status` every 3 seconds, shows "Syncing... this may take a few minutes" with animated indicator, auto-refreshes when complete.

## UX 4: Preset Default + Remove Custom

Change preset `<select>` default from "-- Custom --" to "Weekly Cutoff Unmet". Remove the custom option. Users can still modify all fields after selecting a preset.

## UX 5: Adaptive Cooldown Description

Add `<small>` help text under Cooldown Mode select:
- **Adaptive:** "Searches fresh content every 6 hours, older content less frequently (up to 7 days). Automatically adjusts based on content age."

## UX 6: Discord Test Auto-Saves

Change Test Notification handler to: (1) POST to save config, (2) on success POST to test. Show inline status progression.

## UX 7: Search Activity Terminology

Rename throughout UI:
- `items_found` -> "Eligible" (items that passed filters)
- `searches_triggered` -> "Searched" (actual API calls sent)
- Add `grabs_confirmed` as "Grabbed" where available

## UX 8: Prowlarr Test Connection Polish

1. **Auto-save before test** — same pattern as Discord (#6)
2. **Visual feedback** — success (green + version) or failure (red + hint) inline
3. **Docker URL hints** — `<small>` text: "For Docker: try `http://prowlarr:9696` (same network) or `http://host.docker.internal:9696` (host machine)"

## UX 9: Indexer Health Clarity

Rework columns to: Indexer | Query Limit ("100/day" or "No limit") | Queries Used ("42 of 100") | Status

## UX 10: Indexer Health Truncation

Show first 5 indexers. If more exist, show "Show all N indexers" expand link.
