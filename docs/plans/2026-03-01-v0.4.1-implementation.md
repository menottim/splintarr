# v0.4.1 Implementation Plan — Bug Fixes + UX Polish

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix two blocking bugs (scheduler failure, database locking) and ship 8 UX improvements from hand-testing feedback.

**Architecture:** Bugs are infrastructure fixes (scheduler job store swap, SQLCipher busy_timeout). UX items are template/JS changes with minimal backend modifications. All changes are backward-compatible.

**Tech Stack:** Python 3.13, APScheduler, SQLCipher, Jinja2/JS templates, FastAPI

---

## Task 1: Fix Scheduler Serialization Error

**Files:**
- Modify: `src/splintarr/services/scheduler.py`

Replace `SQLAlchemyJobStore` with `MemoryJobStore` in `_create_scheduler()`. Remove the `get_engine` import and `SQLAlchemyJobStore` import. Update comments that mention job persistence. Jobs are re-scheduled from DB on startup so persistence is unnecessary for a single-container app.

**Test:** `.venv/bin/python -m pytest tests/unit/ -k "scheduler or prowlarr_integration" --no-cov -q`

**Commit:** `fix: replace SQLAlchemyJobStore with MemoryJobStore to avoid closure serialization`

---

## Task 2: Fix SQLCipher Database Locking

**Files:**
- Modify: `src/splintarr/database.py`

Add `PRAGMA busy_timeout = 5000` in two places:
1. In the `creator()` closure inside `create_database_engine()`, after the `kdf_iter` PRAGMA
2. In `set_sqlite_pragma()`, as the first PRAGMA before `foreign_keys`

This gives connections 5 seconds to wait for locks before failing. WAL mode is already enabled.

**Test:** `.venv/bin/python -m pytest tests/unit/test_database.py --no-cov -q`

**Commit:** `fix: add PRAGMA busy_timeout to prevent database lock cascade during sync`

---

## Task 3: Library Refresh Loading Animation

**Files:**
- Modify: `src/splintarr/api/library.py` (add sync-status endpoint + tracking flag)
- Modify: `src/splintarr/templates/dashboard/library.html` (update syncLibrary JS)

Add a module-level `_sync_in_progress` flag and `GET /api/library/sync-status` endpoint. Update `_run_sync_all_background` to set/clear the flag. Replace the 30-second setTimeout in `library.html` with a fullscreen overlay (built with safe DOM methods, not innerHTML) and a 3-second polling loop that checks sync-status and auto-refreshes when done.

**Test:** Manual — trigger sync, verify overlay appears, page refreshes when done.

**Commit:** `feat: persistent loading animation during library sync with polling`

---

## Task 4: Preset Default + Remove Custom

**Files:**
- Modify: `src/splintarr/templates/dashboard/search_queues.html`

Remove the `<option value="">-- Custom --</option>` from the preset select. Change the default to `<option value="weekly-cutoff" selected>Weekly Cutoff Unmet</option>`. In the JS that opens the create modal, call `applyPreset('weekly-cutoff')` so the form fields are pre-populated.

**Test:** Manual — open Create Queue modal, verify Weekly Cutoff Unmet is selected and fields are populated.

**Commit:** `fix: default preset to Weekly Cutoff Unmet, remove custom option`

---

## Task 5: Adaptive Cooldown Description

**Files:**
- Modify: `src/splintarr/templates/dashboard/search_queues.html`

Add `<small>` help text after the Cooldown Mode select: "Adaptive searches fresh content every 6 hours, older content less often (up to 7 days). Automatically adjusts based on content age and search history."

**Commit:** `fix: add description for adaptive cooldown mode in queue modal`

---

## Task 6: Discord + Prowlarr Auto-Save Before Test

**Files:**
- Modify: `src/splintarr/templates/dashboard/settings.html`

Update both test button handlers (Discord `testNotificationBtn` and Prowlarr `testProwlarrBtn`) to: (1) POST to save the config, (2) show "Saving..." status, (3) on success POST to test, (4) show "Testing..." then pass/fail result.

Add Docker URL hint `<small>` under the Prowlarr URL input: "For Docker: try `http://prowlarr:9696` (same Docker network) or `http://host.docker.internal:9696` (host machine)"

**Test:** Manual — enter Discord webhook, click Test, verify it saves then tests. Same for Prowlarr.

**Commit:** `fix: auto-save before test for Discord and Prowlarr, add Docker URL hints`

---

## Task 7: Search Activity Terminology

**Files:**
- Modify: `src/splintarr/templates/dashboard/index.html` (Recent Activity JS)
- Modify: `src/splintarr/templates/dashboard/search_queue_detail.html` (execution history)

In the dashboard activity table JS, change from `items_searched + ' searched'` / `items_found + ' found'` to: `searches_triggered + ' searched'` with `' of ' + items_found + ' eligible'`. In queue detail, update the history table column labels: "Searched" (searches_triggered), "Eligible" (items_found). Show "Grabbed" where grabs_confirmed data is available.

**Commit:** `fix: clarify search activity terminology (eligible/searched/grabbed)`

---

## Task 8: Indexer Health Widget Improvements

**Files:**
- Modify: `src/splintarr/api/dashboard.py` (api_indexer_health response)
- Modify: `src/splintarr/templates/dashboard/index.html` (widget HTML + JS)

Update API to include `limits_unit` per indexer. Simplify columns to: Indexer | Query Limit ("100/day" or "No limit") | Queries Used ("42 of 100") | Status. Add truncation: show first 5 indexers with "Show all N indexers" expand link. Use safe DOM methods (createElement/textContent) for all dynamic content.

**Commit:** `fix: improve indexer health widget clarity and add truncation`

---

## Task 9: Lint, Test, Final Verification

Run full lint and test suite. Verify zero new failures beyond baseline.

**Commit:** `chore: lint and format for v0.4.1`
